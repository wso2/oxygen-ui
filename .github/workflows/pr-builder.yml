# This workflow will build PRs submitted to the main branch.

name: ğŸ‘·â€â™‚ï¸ PR Builder

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - "**/*.md"
      - "LICENSE"
  workflow_dispatch:

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

jobs:
  lint:
    name: ğŸŒ³ ESLint (STATIC ANALYSIS)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [lts/*]
        pnpm-version: [latest]
    steps:
      - name: â¬‡ï¸ Checkout
        id: checkout
        uses: actions/checkout@v2.3.3
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup node
        id: setup-node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ³ Set SHAs for Nx
        id: set-shas
        uses: nrwl/nx-set-shas@v3
        with:
          main-branch-name: "main"

      - name: ğŸ¥¡ Setup pnpm
        id: setup-pnpm
        uses: pnpm/action-setup@v2.1.0
        with:
          version: ${{ matrix.pnpm-version }}
          run_install: false

      - name: ğŸˆ Get pnpm store directory
        id: get-pnpm-cache-dir
        run: |
          echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

      - name: ğŸ”† Cache pnpm modules
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: ${{ steps.get-pnpm-cache-dir.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ§© Install Dependencies
        id: install-dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build Project
        id: build
        run:  pnpm build

      - name: ğŸŒ³ Lint ES Files
        id: lint-with-eslint
        run: pnpm nx affected --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }} --target=lint:es --parallel=3

      - name: ğŸ’… Lint Styles
        id: lint-with-stylelint
        run: |
          # List the stylelint versions used
          pnpm list stylelint -r
          # Print the stylelint configuration
          npx stylelint 'packages/react/src/components/SignIn/sign-in.scss' --config stylelint.config.cjs --allow-empty-input --print-config
          # Run the stylelint target
          pnpm nx affected --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }} --target=lint:styles --parallel=3

  typecheck:
    name: Ê¦ Typecheck (STATIC ANALYSIS)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [lts/*]
        pnpm-version: [latest]
    steps:
      - name: â¬‡ï¸ Checkout
        id: checkout
        uses: actions/checkout@v2.3.3
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup node
        id: setup-node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ³ Set SHAs for Nx
        id: set-shas
        uses: nrwl/nx-set-shas@v3
        with:
          main-branch-name: "main"

      - name: ğŸ¥¡ Setup pnpm
        uses: pnpm/action-setup@v2.1.0
        with:
          version: ${{ matrix.pnpm-version }}
          run_install: false

      - name: ğŸˆ Get pnpm store directory
        id: get-pnpm-cache-dir
        run: |
          echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

      - name: ğŸ”† Cache pnpm modules
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: ${{ steps.get-pnpm-cache-dir.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ§© Install Dependencies
        id: install-dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build Project
        id: build
        run:  pnpm build

      - name: â˜„ï¸ Check Type Errors
        run: pnpm nx affected --base=${{ env.NX_BASE }} --head=${{ env.NX_HEAD }} --target=typecheck --parallel=3

  test:
    name: ğŸ‘¾ Unit Tests
    needs: [ lint, typecheck ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [lts/*]
        pnpm-version: [latest]
    steps:
      - name: â¬‡ï¸ Checkout
        id: checkout
        uses: actions/checkout@v2.3.3
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup node
        id: setup-node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ¥¡ Setup pnpm
        uses: pnpm/action-setup@v2.1.0
        with:
          version: ${{ matrix.pnpm-version }}
          run_install: false

      - name: ğŸˆ Get pnpm store directory
        id: get-pnpm-cache-dir
        run: |
          echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

      - name: ğŸ”† Cache pnpm modules
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: ${{ steps.get-pnpm-cache-dir.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ§© Install Dependencies
        id: install-dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build Project
        id: build
        run:  pnpm build

      - name: ğŸƒ Run Unit Tests
        id: run-tests
        run: pnpm test

      - name: Upload `@oxygen-ui/logger` coverage reports to Codecov
        id: upload-oxygen-ui-logger-coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ env.CODECOV_TOKEN }}
          files: ./packages/logger/coverage/coverage-final.json
          flags: '@oxygen-ui/logger'
          verbose: true

      - name: Upload `@oxygen-ui/primitives` coverage reports to Codecov
        id: upload-oxygen-ui-primitives-coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ env.CODECOV_TOKEN }}
          files: ./packages/primitives/coverage/coverage-final.json
          flags: '@oxygen-ui/primitives'
          verbose: true

      - name: Upload `@oxygen-ui/react` coverage reports to Codecov
        id: upload-oxygen-ui-react-coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ env.CODECOV_TOKEN }}
          files: ./packages/react/coverage/coverage-final.json
          flags: '@oxygen-ui/react'
          verbose: true

      - name: Upload `@oxygen-ui/react-icons` coverage reports to Codecov
        id: upload-oxygen-ui-react-icons-coverage
        uses: codecov/codecov-action@v4
        with:
          token: ${{ env.CODECOV_TOKEN }}
          files: ./packages/react-icons/coverage/coverage-final.json
          flags: '@oxygen-ui/react-icons'
          verbose: true
  storybook:
    name: ğŸ’… Storybook
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [lts/*]
        pnpm-version: [latest]
    steps:
      - name: â¬‡ï¸ Checkout
        id: checkout
        uses: actions/checkout@v2.3.3

      - name: ğŸŸ¢ Setup node
        id: setup-node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ¥¡ Setup pnpm
        uses: pnpm/action-setup@v2.1.0
        with:
          version: ${{ matrix.pnpm-version }}
          run_install: false

      - name: ğŸˆ Get pnpm store directory
        id: get-pnpm-cache-dir
        run: |
          echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

      - name: ğŸ”† Cache pnpm modules
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: ${{ steps.get-pnpm-cache-dir.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ§© Install Dependencies
        id: install-dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build Project Project
        id: build
        run:  pnpm build

      - name: ğŸ’… Build Storybook
        id: build-storybook
        working-directory: packages/react
        run:  pnpm build:storybook

  build:
    name: ğŸš§ Build
    needs: [ lint, typecheck, test, storybook ]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [lts/*]
        pnpm-version: [latest]
    steps:
      - name: â¬‡ï¸ Checkout
        id: checkout
        uses: actions/checkout@v2.3.3

      - name: ğŸŸ¢ Setup node
        id: setup-node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}

      - name: ğŸ¥¡ Setup pnpm
        uses: pnpm/action-setup@v2.1.0
        with:
          version: ${{ matrix.pnpm-version }}
          run_install: false

      - name: ğŸˆ Get pnpm store directory
        id: get-pnpm-cache-dir
        run: |
          echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

      - name: ğŸ”† Cache pnpm modules
        uses: actions/cache@v3
        id: pnpm-cache
        with:
          path: ${{ steps.get-pnpm-cache-dir.outputs.pnpm_cache_dir }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ§© Install Dependencies
        id: install-dependencies
        run: pnpm install

      - name: ğŸ—ï¸ Build Project
        id: build
        run:  pnpm build
